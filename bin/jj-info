#!/bin/sh
# jj doesn't really use branches, so we don't print anything other than whether the workspace is modified
# if there are branches, this is probably a co-located git repo, so `git_info` will just work without having to call this function.

if [ -n "$ZSH_VERSION" ]; then
	ansi_escape () { printf "%%{$1%%}"; }
elif [ -n "$FISH_VERSION" ]; then
	ansi_escape () { command printf "\e(0%s\e(1" "${1}"; }
else
	ansi_escape () { command printf "\01$1\02"; }
fi

RED="$(ansi_escape "\033[0;31m")"
FAINT_GREEN="$(ansi_escape "\033[2;32m")"
FAINT_WHITE="$(ansi_escape "\033[2;37m")"

print_jj_desc() {
	desc=$1; color=$2
	printf %s " $FAINT_WHITE(${color}jj${FAINT_WHITE}: ${RESET}${desc}${FAINT_WHITE})"
}

# hack: gather info for a bunch of commits at once, because jj takes ~50 ms to startup on rl-/rust.
# if there's an error here, we'll see it because we don't redirect stderr.
info=$(jj log -T 'empty++":"++description++"\n"' -r '@|@-' --no-graph --ignore-working-copy)

color=$RED
if [ "$(echo "$info" | head -n1 | cut -d : -f1)" = true ]; then
	color=$FAINT_GREEN
fi
desc=$(echo "$info" | tail -n+2 | cut -d : -f2-)

print_jj_desc "$desc" "$color"
