#!/bin/sh

set -e

exists () {
	command -v "$1" >/dev/null 2>&1
}

fatal() {
	echo "$@" >&2
	exit 1
}

main() {
	mode=$1; shift

	# X11
	if exists xclip; then
		prog=xclip
		type=--type
		# https://wiki.archlinux.org/title/Tmux#On_Xorg
		in="-in >/dev/null"
		out=-out
		primary="-selection primary"
		clipboard="-selection clipboard"
	# X11, no --type support
	elif exists xsel; then
		prog=xsel
		in=--input
		out=--output
		primary=--primary
		clipboard=--cliboard

	# Wayland
	elif exists wl-copy; then
		if [ "$mode" = copy ]; then
			prog=wl-copy
		else
			prog=wl-paste
		fi
		type=--type
		in=
		out=
		primary=--primary
		clipboard=

	# MacOS, no --type support currently.
	# might be possible to add using `osascript`.
	elif exists pbcopy; then
		if [ "$mode" = copy ]; then
			prog=pbcopy
		else
			prog=pbpaste
		fi
		in=
		out=
		primary="-pboard find"
		clipboard="-pboard general"
	else
		# TODO: windows
		fatal "no clipboard manager detected"
	fi

	if [ "$1" = --type ]; then
		if [ -z "$type" ]; then
			fatal "$prog doesn't support --type"
		else
			type="$type $2"
			shift; shift
		fi
	else
		type=
	fi

	case "${mode}:${2}" in
		copy:--primary) $prog $in $type $primary;;
		paste:--primary) $prog $out $type $primary;;
		copy:*) $prog $in $type $clipboard;;
		paste:*) $prog $out $type $clipboard;;
	esac
}

mode=$(basename "$0")
case "$mode" in
	copy) ;;
	paste) ;;
	*) fatal "unknown operation $0";;
esac

main "$mode" "$@"
